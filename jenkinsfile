pipeline {
    agent any
    
    environment {
        FTP_SERVER = 'site7717.siteasp.net'
        FTP_USER = 'site7717'
        // Use credentials for FTP password
        FTP_CREDS = credentials('ftp-credentials')
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Restore packages') {
            steps {
                bat 'dotnet restore'
            }
        }
        
        stage('Build') {
            steps {
                bat 'dotnet build --configuration Release --no-restore'
            }
        }
        
        stage('Publish') {
            steps {
                bat 'dotnet publish -c Release -o ./publish'
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    // Install WinSCP if not already available
                    bat 'if not exist "C:\\Program Files (x86)\\WinSCP\\WinSCP.com" powershell Invoke-WebRequest "https://downloads.sourceforge.net/project/winscp/WinSCP/5.17.10/WinSCP-5.17.10-Portable.zip" -OutFile winscp.zip && powershell Expand-Archive winscp.zip -DestinationPath C:\\WinSCP'
                    
                    // Create WinSCP script
                    writeFile file: 'ftp_script.txt', text: """
                    open ftp://${FTP_USER}:${FTP_CREDS_PSW}@${FTP_SERVER}
                    synchronize remote ./publish /wwwroot
                    exit
                    """
                    
                    // Run WinSCP
                    bat '"C:\\Program Files (x86)\\WinSCP\\WinSCP.com" /script=ftp_script.txt /log=winscp.log'
                }
            }
        }
    }
    
    post {
        always {
            // Clean up sensitive files
            bat 'del ftp_script.txt'
        }
    }
}



